<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</title>
<style>
  body{font-family:sans-serif;padding:20px;background:#f9f9f9;}
  h1{color:#333;}
  table{width:100%;border-collapse:collapse;margin-bottom:20px;}
  th,td{border:1px solid #ccc;padding:8px;text-align:center;}
  th{background:#eee;}
  button{padding:5px 10px;margin:2px;cursor:pointer;}
  .success{color:green;}
  .error{color:red;}
  #adminLogin{margin-bottom:20px; padding:15px; background:#eee; border-radius:8px;}
  #adminArea{display:none;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
<h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©</h1>

<!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="adminLogin">
  <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
  <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</label><br>
  <input type="email" id="adminEmail"><br>
  <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label><br>
  <input type="password" id="adminPass"><br><br>
  <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <div id="loginMsg" class="error"></div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminArea">
  <div id="stats"></div>

  <h2>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©</h2>
  <table id="codesTable">
    <thead><tr>
      <th>Ø§Ù„ÙƒÙˆØ¯</th><th>UID</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø­Ø°Ù</th>
    </tr></thead>
    <tbody></tbody>
  </table>

  <h2>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h2>
  <table id="blockedTable">
    <thead><tr>
      <th>Device Hash</th><th>Reporter UID</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±</th><th>Ø­Ø°Ù</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
  authDomain: "website-83e14.firebaseapp.com",
  databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
  projectId: "website-83e14",
  storageBucket: "website-83e14.firebasestorage.app",
  messagingSenderId: "994953388464",
  appId: "1:994953388464:web:9c244de2a4fdcf8561f675"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

// Ù‚Ø§Ø¦Ù…Ø© UIDØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
const ADMIN_UIDS = ["gI2tAMAFdZfpqj9TspSfWvgu6i33"];

const adminLoginDiv = document.getElementById('adminLogin');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const adminArea = document.getElementById('adminArea');

loginBtn.onclick = async () => {
  const email = document.getElementById('adminEmail').value;
  const pass = document.getElementById('adminPass').value;
  loginMsg.textContent = '';
  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    if(!ADMIN_UIDS.includes(uid)){
      loginMsg.textContent = 'âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” UID ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø£Ø¯Ù…Ù†';
      await auth.signOut();
      return;
    }
    adminLoginDiv.style.display='none';
    adminArea.style.display='block';
    loadActivatedCodes();
    loadBlockedDevices();
  }catch(e){
    loginMsg.textContent = 'âŒ Ø®Ø·Ø£: '+ (e.message||e);
  }
}

// Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(ts){ return ts?new Date(ts).toLocaleString():'---'; }

// Ø­Ø°Ù ÙƒÙˆØ¯ Ù…ÙØ¹Ù‘Ù„
function deleteActivatedCode(uid){
  if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† UID '+uid+'ØŸ')){
    db.ref('approvedStudents/'+uid).remove().then(()=>loadActivatedCodes());
  }
}

// Ø­Ø°Ù Ø¬Ù‡Ø§Ø² Ù…Ø­Ø¸ÙˆØ±
function deleteBlockedDevice(fp){
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø­Ø¸ÙˆØ± '+fp+'ØŸ')){
    db.ref('blockedDevices/'+fp).remove().then(()=>loadBlockedDevices());
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø©
function loadActivatedCodes(){
  const tbody=document.querySelector('#codesTable tbody');
  tbody.innerHTML='';
  db.ref('approvedStudents').once('value').then(snap=>{
    let activeCount=0,trialCount=0,freeCount=0,expiredCount=0;
    const now=Date.now();
    snap.forEach(child=>{
      const data=child.val();
      const tr=document.createElement('tr');
      const expired=data.expiry && now>data.expiry;
      if(expired) expiredCount++;
      else if(data.type==='trial') trialCount++;
      else if(data.type==='free') freeCount++;
      else activeCount++;
      tr.innerHTML=`
        <td>${data.code||'---'}</td>
        <td>${child.key}</td>
        <td>${data.type||'---'}</td>
        <td>${formatDate(data.activationAt)}</td>
        <td>${formatDate(data.expiry)}</td>
        <td><button onclick="deleteActivatedCode('${child.key}')">Ø­Ø°Ù</button></td>
      `;
      tbody.appendChild(tr);
      // Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠ
      if(expired) db.ref('approvedStudents/'+child.key).remove();
    });
    document.getElementById('stats').innerHTML=`<strong>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:</strong> Ù…ÙØ¹Ù„: ${activeCount}, ØªØ¬Ø±Ø¨Ø©: ${trialCount}, Ù…Ø¬Ø§Ù†ÙŠ: ${freeCount}, Ù…Ù†ØªÙ‡ÙŠ: ${expiredCount}`;
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
function loadBlockedDevices(){
  const tbody=document.querySelector('#blockedTable tbody');
  tbody.innerHTML='';
  db.ref('blockedDevices').once('value').then(snap=>{
    snap.forEach(child=>{
      const data=child.val();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${child.key}</td>
        <td>${data.reporterUid||'---'}</td>
        <td>${formatDate(data.blockedAt)}</td>
        <td><button onclick="deleteBlockedDevice('${child.key}')">Ø­Ø°Ù</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø´ÙŠØ¡ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
setInterval(()=>{
  if(adminArea.style.display==='block'){ // ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
    loadActivatedCodes();
    loadBlockedDevices();
  }
},5000);
</script>
</body>
</html>
